{% extends "base.html" %}

{% block title %}Artwork Detail - Classic Art Gallery{% endblock %}

{% block content %}
<div x-data="artworkDetail()" x-init="init()">
    <!-- Loading State -->
    <div x-show="loading" class="text-center py-12">
        <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-indigo-600"></div>
        <p class="mt-2 text-gray-600">Loading artwork...</p>
    </div>

    <!-- Error State -->
    <div x-show="error" class="px-4 sm:px-0">
        <div class="bg-red-50 border border-red-200 rounded-md p-4">
            <p class="text-red-800" x-text="error"></p>
            <a href="/" class="mt-4 inline-block text-indigo-600 hover:text-indigo-900">‚Üê Back to Gallery</a>
        </div>
    </div>

    <!-- Artwork Detail -->
    <div x-show="!loading && !error && artwork" class="px-4 sm:px-0">
        <!-- Back Button -->
        <div class="mb-6">
            <a href="/" class="text-indigo-600 hover:text-indigo-900 flex items-center">
                <svg class="w-5 h-5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                Back to Gallery
            </a>
        </div>

        <div class="bg-white rounded-lg shadow-lg overflow-hidden">
            <div class="md:flex">
                <!-- Image -->
                <div class="md:w-1/2 bg-gray-100 flex items-center justify-center cursor-pointer" @click="openImageModal()">
                    <img 
                        :src="artwork.image_url" 
                        :alt="artwork.title" 
                        class="w-full h-full object-contain p-8 hover:opacity-90 transition-opacity"
                        @error="handleImageError($event)"
                    >
                </div>

                <!-- Details -->
                <div class="md:w-1/2 p-8">
                    <div class="space-y-6">
                        <div>
                            <h1 class="text-3xl font-bold text-gray-900" x-text="artwork.title"></h1>
                            <p class="text-xl text-gray-600 mt-2" x-text="artwork.artist"></p>
                        </div>

                        <div class="border-t border-gray-200 pt-6">
                            <dl class="space-y-4">
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Style</dt>
                                    <dd class="mt-1 text-sm text-gray-900" x-text="artwork.style"></dd>
                                </div>
                                
                                <div x-show="artwork.year">
                                    <dt class="text-sm font-medium text-gray-500">Year</dt>
                                    <dd class="mt-1 text-sm text-gray-900" x-text="artwork.year"></dd>
                                </div>
                                
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Popularity Score</dt>
                                    <dd class="mt-1 text-sm text-gray-900">
                                        <span x-text="(artwork.popularity_score * 100).toFixed(1)"></span>%
                                    </dd>
                                </div>
                                
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Views</dt>
                                    <dd class="mt-1 text-sm text-gray-900" x-text="artwork.views"></dd>
                                </div>
                                
                                <div>
                                    <dt class="text-sm font-medium text-gray-500">Status</dt>
                                    <dd class="mt-1">
                                        <span 
                                            :class="artwork.is_active ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'"
                                            class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium"
                                            x-text="artwork.is_active ? 'Active' : 'Inactive'"
                                        ></span>
                                    </dd>
                                </div>
                            </dl>
                        </div>

                        <div class="border-t border-gray-200 pt-6">
                            <div class="flex space-x-3">
                                <button 
                                    @click="toggleLike()"
                                    :class="isLiked ? 'bg-red-600 hover:bg-red-700' : 'bg-gray-300 hover:bg-gray-400'"
                                    class="flex-1 text-white px-4 py-2 rounded-md transition-colors flex items-center justify-center"
                                    :disabled="liking"
                                >
                                    <svg class="w-5 h-5 mr-2" :fill="isLiked ? 'currentColor' : 'none'" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                                    </svg>
                                    <span x-text="isLiked ? 'Liked' : 'Like'"></span>
                                </button>
                                <button 
                                    @click="shareArtwork()"
                                    class="flex-1 bg-indigo-600 text-white px-4 py-2 rounded-md hover:bg-indigo-700 transition-colors"
                                >
                                    Share
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Additional Information -->
        <div class="mt-8 bg-white rounded-lg shadow p-6">
            <h2 class="text-xl font-bold text-gray-900 mb-4">About the Artist</h2>
            {% if artist_description %}
            <p class="text-gray-700">{{ artist_description }}</p>
            {% else %}
            <p class="text-gray-500 italic">Artist information not available.</p>
            {% endif %}
            
            <div class="mt-6 pt-6 border-t border-gray-200">
                <h3 class="text-lg font-semibold text-gray-900 mb-3">Artwork Details</h3>
                <p class="text-gray-700">
                    <strong x-text="artwork.title"></strong> by <strong x-text="artwork.artist"></strong> 
                    is a masterpiece from the <strong x-text="artwork.style"></strong> period.
                    <template x-if="artwork.year">
                        Created in <strong x-text="artwork.year"></strong>,
                    </template>
                    this artwork showcases the distinctive characteristics of its artistic style.
                </p>
            </div>
        </div>

        <!-- Comments Section -->
        <div class="mt-8 bg-white rounded-lg shadow p-6" x-data="commentsSection()" x-init="loadComments()">
            <h2 class="text-xl font-bold text-gray-900 mb-4">Comments</h2>
            
            <!-- Comment Form (shown only if logged in) -->
            <div class="mb-6" x-show="isAuthenticated">
                <form @submit.prevent="postComment()" class="space-y-4">
                    <div>
                        <textarea 
                            x-model="newCommentContent"
                            rows="3"
                            placeholder="Share your thoughts about this artwork..."
                            class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-indigo-500 focus:border-indigo-500"
                            maxlength="1000"
                        ></textarea>
                        <div class="mt-1 text-sm text-gray-500" x-text="`${newCommentContent.length}/1000 characters`"></div>
                    </div>
                    <button 
                        type="submit"
                        :disabled="!newCommentContent.trim() || postingComment"
                        class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <span x-show="!postingComment">Post Comment</span>
                        <span x-show="postingComment">Posting...</span>
                    </button>
                </form>
            </div>
            
            <!-- Login message (shown only if not logged in) -->
            <div class="mb-6 p-4 bg-gray-50 rounded-md" x-show="!isAuthenticated">
                <p class="text-gray-700">
                    Please <a :href="`/login?next=/artworks/${getArtworkIdFromUrl()}`" class="text-indigo-600 hover:text-indigo-900">login</a> to leave a comment.
                </p>
            </div>
            
            <!-- Comments List -->
            <div class="space-y-4">
                <template x-if="loadingComments">
                    <div class="text-center py-4">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-indigo-600"></div>
                    </div>
                </template>
                
                <template x-if="!loadingComments && comments.length === 0">
                    <p class="text-gray-500 text-center py-4">No comments yet. Be the first to share your thoughts!</p>
                </template>
                
                <template x-for="comment in comments" :key="comment.id">
                    <div class="border-t border-gray-200 pt-4">
                        <div class="flex justify-between items-start">
                            <div class="flex-1">
                                <div class="flex items-center space-x-2">
                                    <span class="font-semibold text-gray-900" x-text="comment.username"></span>
                                    <span class="text-sm text-gray-500" x-text="formatDate(comment.created_at)"></span>
                                </div>
                                <p class="mt-2 text-gray-700 whitespace-pre-wrap" x-text="comment.content"></p>
                            </div>
                            <template x-if="canDeleteComment(comment)">
                                <button 
                                    @click="deleteComment(comment.id)"
                                    class="ml-4 text-red-600 hover:text-red-900 text-sm"
                                >
                                    Delete
                                </button>
                            </template>
                        </div>
                    </div>
                </template>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function artworkDetail() {
        return {
            artwork: null,
            loading: false,
            error: null,
            isLiked: false,
            liking: false,
            
            async init() {
                const artworkId = this.getArtworkIdFromUrl();
                if (artworkId) {
                    await this.loadArtwork(artworkId);
                    await this.checkIfLiked(artworkId);
                } else {
                    this.error = 'Invalid artwork ID';
                }
            },
            
            getArtworkIdFromUrl() {
                const pathParts = window.location.pathname.split('/');
                return pathParts[pathParts.length - 1];
            },
            
            async loadArtwork(id) {
                this.loading = true;
                this.error = null;
                
                try {
                    const response = await fetch(`/api/v1/artworks/${id}`);
                    
                    if (!response.ok) {
                        if (response.status === 404) {
                            throw new Error('Artwork not found');
                        }
                        throw new Error('Failed to load artwork');
                    }
                    
                    this.artwork = await response.json();
                } catch (err) {
                    this.error = err.message;
                } finally {
                    this.loading = false;
                }
            },
            
            async checkIfLiked(artworkId) {
                const token = localStorage.getItem('access_token');
                if (!token) return;
                
                try {
                    const response = await fetch(`/api/v1/me/likes`, {
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok) {
                        const likes = await response.json();
                        this.isLiked = likes.some(like => like.artwork_id === artworkId);
                    }
                } catch (error) {
                    console.error('Error checking like status:', error);
                }
            },
            
            async toggleLike() {
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = `/login?next=${encodeURIComponent(window.location.pathname)}`;
                    return;
                }
                
                const artworkId = this.getArtworkIdFromUrl();
                this.liking = true;
                
                try {
                    // Use DELETE if already liked, POST if not liked
                    const method = this.isLiked ? 'DELETE' : 'POST';
                    const response = await fetch(`/api/v1/likes/${artworkId}`, {
                        method: method,
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        this.isLiked = data.liked;
                    } else if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        window.location.href = `/login?next=${encodeURIComponent(window.location.pathname)}`;
                    }
                } catch (error) {
                    console.error('Error toggling like:', error);
                } finally {
                    this.liking = false;
                }
            },
            
            openImageModal() {
                // Create a simple modal for image expansion
                const modal = document.createElement('div');
                modal.innerHTML = `
                    <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onclick="this.remove()">
                        <div class="relative max-w-4xl max-h-screen" onclick="event.stopPropagation()">
                            <img src="${this.artwork.image_url}" alt="${this.artwork.title}" class="w-full h-full object-contain">
                            <button onclick="this.closest('div').parentElement.remove()" class="absolute top-4 right-4 text-white bg-black bg-opacity-50 rounded-full w-10 h-10 flex items-center justify-center hover:bg-opacity-75">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            },
            
            shareArtwork() {
                const url = window.location.href;
                if (navigator.share) {
                    navigator.share({
                        title: this.artwork.title,
                        text: `Check out ${this.artwork.title} by ${this.artwork.artist}`,
                        url: url
                    });
                } else {
                    // Fallback: copy to clipboard
                    navigator.clipboard.writeText(url).then(() => {
                        alert('Link copied to clipboard!');
                    });
                }
            },
            
            handleImageError(event) {
                event.target.src = 'data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="400" height="300"%3E%3Crect fill="%23ddd" width="400" height="300"/%3E%3Ctext fill="%23999" font-family="sans-serif" font-size="20" dy="10.5" font-weight="bold" x="50%25" y="50%25" text-anchor="middle"%3EImage Not Found%3C/text%3E%3C/svg%3E';
            }
        }
    }
    
    function commentsSection() {
        return {
            comments: [],
            loadingComments: false,
            postingComment: false,
            newCommentContent: '',
            isAuthenticated: false,
            currentUserId: null,
            currentUserRole: null,
            
            async init() {
                this.checkAuth();
            },
            
            async checkAuth() {
                const token = localStorage.getItem('access_token');
                if (token) {
                    try {
                        const response = await fetch('/api/v1/auth/me', {
                            headers: {
                                'Authorization': `Bearer ${token}`
                            }
                        });
                        if (response.ok) {
                            const data = await response.json();
                            this.isAuthenticated = true;
                            this.currentUserId = data.id;
                            this.currentUserRole = data.role;
                        }
                    } catch (error) {
                        console.error('Error checking auth:', error);
                    }
                }
            },
            
            getArtworkIdFromUrl() {
                const pathParts = window.location.pathname.split('/');
                return pathParts[pathParts.length - 1];
            },
            
            async loadComments() {
                this.loadingComments = true;
                try {
                    const artworkId = this.getArtworkIdFromUrl();
                    const response = await fetch(`/api/v1/comments/${artworkId}`);
                    if (response.ok) {
                        this.comments = await response.json();
                    }
                } catch (error) {
                    console.error('Error loading comments:', error);
                } finally {
                    this.loadingComments = false;
                }
            },
            
            async postComment() {
                if (!this.newCommentContent.trim()) return;
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                this.postingComment = true;
                try {
                    const artworkId = this.getArtworkIdFromUrl();
                    const response = await fetch(`/api/v1/comments/${artworkId}`, {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ content: this.newCommentContent })
                    });
                    
                    if (response.ok) {
                        const newComment = await response.json();
                        this.comments.unshift(newComment);
                        this.newCommentContent = '';
                    } else if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                    }
                } catch (error) {
                    console.error('Error posting comment:', error);
                } finally {
                    this.postingComment = false;
                }
            },
            
            async deleteComment(commentId) {
                if (!confirm('Are you sure you want to delete this comment?')) return;
                
                const token = localStorage.getItem('access_token');
                if (!token) {
                    window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                    return;
                }
                
                try {
                    const response = await fetch(`/api/v1/comments/${commentId}`, {
                        method: 'DELETE',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        }
                    });
                    
                    if (response.ok || response.status === 204) {
                        this.comments = this.comments.filter(c => c.id !== commentId);
                    } else if (response.status === 401) {
                        localStorage.removeItem('access_token');
                        window.location.href = '/login?next=' + encodeURIComponent(window.location.pathname);
                    }
                } catch (error) {
                    console.error('Error deleting comment:', error);
                }
            },
            
            canDeleteComment(comment) {
                return this.isAuthenticated && (
                    comment.user_id === this.currentUserId || 
                    this.currentUserRole === 'admin' ||
                    this.currentUserRole === 'manager'
                );
            },
            
            formatDate(dateString) {
                if (!dateString) return '';

                // Ensure timestamps without timezone are treated as UTC
                const normalized = /[zZ]|[+-]\d{2}:?\d{2}$/.test(dateString)
                    ? dateString
                    : `${dateString}Z`;

                const date = new Date(normalized);
                if (Number.isNaN(date.getTime())) {
                    return '';
                }

                const now = new Date();
                const diffMs = Math.max(0, now.getTime() - date.getTime());
                const diffSeconds = Math.floor(diffMs / 1000);
                const diffMinutes = Math.floor(diffSeconds / 60);
                const diffHours = Math.floor(diffMinutes / 60);
                const diffDays = Math.floor(diffHours / 24);

                if (diffSeconds < 60) {
                    return 'just now';
                }

                if (diffMinutes === 1) {
                    return '1 minute ago';
                }

                if (diffMinutes < 60) {
                    return `${diffMinutes} minutes ago`;
                }

                if (diffHours === 1) {
                    return '1 hour ago';
                }

                if (diffHours < 24) {
                    return `${diffHours} hours ago`;
                }

                if (diffDays === 1) {
                    return '1 day ago';
                }

                if (diffDays < 30) {
                    return `${diffDays} days ago`;
                }

                const diffMonths = Math.floor(diffDays / 30);
                if (diffMonths === 1) {
                    return '1 month ago';
                }

                if (diffMonths < 12) {
                    return `${diffMonths} months ago`;
                }

                const diffYears = Math.floor(diffDays / 365);
                if (diffYears <= 1) {
                    return '1 year ago';
                }

                return `${diffYears} years ago`;
            }
        }
    }
</script>
{% endblock %}
